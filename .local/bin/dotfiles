#!/bin/sh
usage() { cat >&2 <<USAGE
Dotfile wrapper over git.

To install:
  curl -L https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/dotfiles | /bin/sh -s install

To push over ssh:
  curl -L https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/dotfiles | ssh <server> /bin/sh -s install

Usage:
  dotfiles [--help]               - This message.
  dotfiles etc                    - Copy ~/.config/dotfiles/etc to /etc
  dotfiles uninstall              - Removes bare repo

Requirements:

  git
  for install: curl
  for pushes: openssh, and keys registered with github
  ~/.local/bin must be in PATH

See also: https://www.atlassian.com/git/tutorials/dotfiles

USAGE
}

# This must be in .zshrc:
# alias config="git --git-dir=$HOME/.dotfiles --work-tree=$HOME"

set -eu

github='mikeslattery/dotfiles'
git_ssh_url="git@github.com:${github}.git"
git_http_url="https://github.com/${github}.git"
export GIT_DIR="$HOME/.dotfiles"
export GIT_WORK_TREE="$HOME"

die() { echo "$*"; exit 1; }

case "${1:---help}" in
  --help)
    usage
    ;;
  install)
    [ ! -d "$GIT_DIR" ] || die "E: $GIT_DIR already exists."
    if ! git config user.name; then
      gitconfig="https://raw.githubusercontent.com/${github}/master/.gitconfig"
      if command -v curl > /dev/null; then
        curl -sLf "$gitconfig" -o ~/.gitconfig
      else
        wget "$gitconfig" -O ~/.gitconfig -q
      fi
    fi
    mkdir -p "$(dirname "$GIT_DIR")"
    set -x
    git clone --bare "$git_ssh_url" "$GIT_DIR" || git clone --bare "$git_http_url" "$GIT_DIR"
    git config --local status.showUntrackedFiles no
    git config --local core.excludesFile ~/.config/dotfiles/gitignore
    git reset --hard
    git config branch.master.remote origin
    git config branch.master.merge refs/heads/master
    ;;
  etc)
    sudo cp -r --preserve=mode ~/.config/dotfiles/etc/* /etc/
    ;;
  uninstall)
    [ -d "$GIT_DIR" ] || die "E: Not installed at $GIT_DIR"
    echo "To remove: rm ~/.local/bin/dotfiles"
    echo "To reinstall: ~/.local/bin/dotfiles install"
    set -x
    rm -rf "$GIT_DIR"
    ;;
  *)
    exec git "$@"
    ;;
esac

#TODO: rename to dotfiles
#TODO: alias config='git --git-dir ... --work-dir ...'

