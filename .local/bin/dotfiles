#!/bin/sh
usage() { cat >&2 <<USAGE
Dotfile wrapper over git.

To install:
  curl -L https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/dotfiles | /bin/sh -s install
or
  wget https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/dotfiles -O - | /bin/sh -s install

Usage:
  dotfiles [help]     - This message.
  dotfiles etc        - Copy ~/.config/dotfiles/etc to /etc
  dotfiles uninstall  - Removes bare repo
  dotfiles ...        - git subcommand. (in case "config" alias not set)
  config   ...        - ditto

Requirements:
  for install: git or unzip, curl or wget
  for pushes: git, openssh, and keys registered with github
  ~/.local/bin must be in PATH.  If not, this should be set in .zshrc
  In .zshrc: alias config="git --git-dir=$HOME/.dotfiles --work-tree=$HOME"

To push/pull over ssh:
  cat ~/.local/bin/dotfiles | ssh <server> /bin/sh -s install
  ssh <server> cat .local/bin/dotfiles | /bin/sh -s install
To push over ssh without git or unzip:
  config archive master | ssh <server> tar -x

See also:
  Other files in .config/dotfiles
  https://www.atlassian.com/git/tutorials/dotfiles

USAGE
}

set -eu

github='mikeslattery/dotfiles'

git_ssh_url="git@github.com:${github}.git"
git_http_url="https://github.com/${github}.git"
export GIT_DIR="$HOME/.dotfiles"
export GIT_WORK_TREE="$HOME"

die() { echo "$*"; exit 1; }

case "${1:-help}" in
  help)
    usage
    ;;
  install)
    if ! command -v git >/dev/null; then
      # fallback to unzip, if git not installed
      command -v unzip >/dev/null || die 'E: git nor unzip are installed'
      cd ~
      zip="https://github.com/${github}/archive/refs/heads/master.zip"
      curl -sfLO "$zip" || wget -q "$zip"
      ln -sfn ~ dotfiles-master
      unzip -o master.zip
      rm master.zip dotfiles-master

      echo 'W: git is not installed.'
    else
      [ ! -d "$GIT_DIR" ] || die "E: $GIT_DIR already exists."
      # If git user not set, download
      if ! git config user.name 2>/dev/null; then
        gitconfig="https://raw.githubusercontent.com/${github}/master/.gitconfig"
        curl -sLf "$gitconfig" -o ~/.gitconfig || wget "$gitconfig" -O ~/.gitconfig -q
      fi
      mkdir -p "$(dirname "$GIT_DIR")"
      set -x
      git clone --bare "$git_ssh_url" "$GIT_DIR" || git clone --bare "$git_http_url" "$GIT_DIR"
      git config --local status.showUntrackedFiles no
      git config --local core.excludesFile ~/.config/dotfiles/gitignore
      git config --local branch.master.remote origin
      git config --local branch.master.merge refs/heads/master
      git reset --hard
    fi
    ;;
  etc)
    sudo cp -rv --preserve=mode ~/.config/dotfiles/etc/* /etc/
    ;;
  uninstall)
    [ -d "$GIT_DIR" ] || die "E: Not installed at $GIT_DIR"
    echo "To remove: rm ~/.local/bin/dotfiles"
    echo "To reinstall: ~/.local/bin/dotfiles install"
    set -x
    rm -rf "$GIT_DIR"
    ;;
  *)
    exec git "$@"
    ;;
esac

