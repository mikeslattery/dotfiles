#!/bin/sh
usage() { cat >&2 <<USAGE
Dotfile wrapper over git.

To install:
  curl -L https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/config | /bin/sh -s install

To push over ssh:
  curl -L https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/config | ssh <server> /bin/sh -s install

Usage:

  config add <file>             - add file to git index
  config add -u                 - add changed tracked files to index
  config commit -m '<message>'  - Save changes to local log
  config push                   - Save changes to repository
  config pull                   - Load changes from repository
  config status                 - View changed and new files

  config help [<command>]       - More help on commands
  config [--help]               - This message.
  config etc                    - Copy ~/.config/dotfiles/etc to /etc
  config uninstall              - Removes bare repo

Usage without this script:

  git --git-dir=~/.dotfiles --work-tree=~ ...

Requirements:

  git
  for install: curl
  for pushes: openssh, and keys registered with github
  ~/.local/bin must be in PATH

See also: https://www.atlassian.com/git/tutorials/dotfiles

To start your own dotfiles project:
  curl https://raw.githubusercontent.com/mikeslattery/dotfiles/master/.local/bin/config -o config
  bash config init <github-user/project>
  rm config

USAGE
}

set -eu

github='mikeslattery/dotfiles'
git_ssh_url="git@github.com:${github}.git"
git_http_url="https://github.com/${github}.git"
export GIT_DIR="$HOME/.dotfiles"
export GIT_WORK_TREE="$HOME"

cd "$(dirname "$0")"

die() { echo "$*"; exit 1; }

case "${1:---help}" in
  --help)
    usage
    ;;
  help)
    git "$@" 2>&1 | sed 's/git[- ]/config /g;' | less -F
    ;;
  init)
    git config user.name || die 'E: Must configure user.email/name'
    [ ! -d "$GIT_DIR" ] || echo "W: $GIT_DIR already exists."

    echo "https://github.com/${2} must already exist."
    echo 'This will ERASE all files of the project, if any.'
    echo 'You must already have registered your ssh keys with github.'
    echo 'Hit Ctrl-C to abort, or Enter to continue:'
    read -r

    # Create initial files
    mkdir -p "$(dirname "$GIT_DIR")" "$HOME/.local/bin"
    [ -f ~/.local/bin/config ] || cp "$0" ~/.local/bin/config
    sed -i "s|$github|$2|" ~/.local/bin/config
    chmod +x ~/.local/bin/config
    basename "$GIT_DIR" >> ~/.gitignore
    (
      # Create local repo
      set -x
      git init --initial-branch=master
      git remote add origin "git@github.com:${2}.git" || true
      git config --local status.showUntrackedFiles no
      git config --local core.excludesFile ~/.config/dotfiles/gitignore
      git add .gitignore .local/bin/config .gitconfig
      git commit -m 'original commit'
    )
    echo 'Hit enter to push to github:'
    read -r
    git push -u -f --verbose origin master
    ;;
  install)
    [ ! -d "$GIT_DIR" ] || die "E: $GIT_DIR already exists."
    if ! git config user.name; then
      gitconfig="https://raw.githubusercontent.com/${github}/master/.gitconfig"
      if command -v curl > /dev/null; then
        curl -sLf "$gitconfig" -o ~/.gitconfig
      else
        wget "$gitconfig" -O ~/.gitconfig -q
      fi
    fi
    mkdir -p "$(dirname "$GIT_DIR")"
    set -x
    git clone --bare "$git_ssh_url" "$GIT_DIR" || git clone --bare "$git_http_url" "$GIT_DIR"
    git config --local status.showUntrackedFiles no
    git config --local core.excludesFile ~/.config/dotfiles/gitignore
    git reset --hard
    ;;
  etc)
    sudo cp -r --preserve=mode ~/.config/dotfiles/etc/* /etc/
    ;;
  uninstall)
    [ -d "$GIT_DIR" ] || die "E: Not installed at $GIT_DIR"
    echo "You may want to run: rm ~/.local/bin/config"
    echo "To reinstall: config install"
    set -x
    rm -rf "$GIT_DIR"
    ;;
  *)
    exec git "$@"
    ;;
esac

