#!/bin/bash
    
# Voice-to-stdout

# https://www.reddit.com/r/vim/comments/113a0vo/i_incorporated_whisper_voicetotext_into_vim/
# simplify popup
# global hotkey and xdotool send-keys

set -eu

dir='/tmp/whisper'
recording="$dir/vtt.wav"
cd "$dir"

install() {
  sudo dnf install ffmpeg
  pip install openai-whisper
}

init() {
  mkdir -p "$dir"
}

record() {
  arecord -d 0 -r44100 "$recording" &>/dev/null &
  recordpid=$!
  trap "kill $recordpid; rm -f $recording" ERR INT
  start="$(date +%s)"
  tmux popup -d "$PWD" -E "
    watching() {
      while true; do
        echo -ne \"(\$(( \$(date +%s) - $start )) seconds)\r\"
        sleep 1
      done
    }

    transcribe() {
      echo ''
      echo 'Transcribing...'
      whisper '$recording' --language English --model tiny --fp16 False --output_format txt
    }

    echo 'Recording...'
    echo 'Hit enter to stop: '
    watching &
    watchpid=\$!
    read
    kill $recordpid \$watchpid
    wait
    transcribe
  "
}

text2stdout() {
  cat "${recording}.txt" | tr $'\n' ' '
  rm "$recording" "${recording}.txt"
}

main() {
  init
  record
  text2stdout
}

main "$@"
